<?php
// Start output buffering to prevent headers from being sent prematurely
ob_start();

// Include config.php
require_once "./config.php";

// Initialize variables
$current_password = $new_password = $confirm_password = "";
$error = "";

// Check if the user is logged in and get the user ID from the session
session_start();

var_dump($_POST); // Check if form data is being submitted correctly

if (isset($_SESSION['user_id'])) {
    $user_id = $_SESSION['user_id'];

    if ($_SERVER["REQUEST_METHOD"] == "POST") {
        $current_password = $_POST['current_password'] ?? '';

        // Query the database to fetch the user's password
        $query = "SELECT password FROM users WHERE id = ?";
        $stmt = mysqli_prepare($link, $query);
        mysqli_stmt_bind_param($stmt, "i", $user_id);
        mysqli_stmt_execute($stmt);
        mysqli_stmt_bind_result($stmt, $db_password);
        mysqli_stmt_fetch($stmt);

        var_dump($current_password); // Check if the current password is being retrieved correctly
        var_dump($db_password); // Check the retrieved password from the database

        if ($db_password) {
            if (password_verify($current_password, $db_password)) {
                $new_password = $_POST['new_password'] ?? '';
                $hashed_new_password = password_hash($new_password, PASSWORD_DEFAULT);

                var_dump($hashed_new_password); // Check the hashed new password

                // Update password in the database using direct query
                $pass_new = mysqli_real_escape_string($link, $hashed_new_password);
                $current_user = mysqli_real_escape_string($link, $user_id);
                $update_query = "UPDATE `users` SET password = '$pass_new' WHERE id = '$current_user'";
                $result = mysqli_query($link, $update_query);

                var_dump(mysqli_affected_rows($link)); // Check if the database update query executed successfully

                // Set success message in session
                $_SESSION['password_change_success'] = "Password changed successfully";

                // Redirect to a success page or display a success message
                header("Location: password_changed.php");
                exit;
            } else {
                $error = "Incorrect current password.";
            }
        } else {
            $error = "User not found.";
        }
    }
}

// End output buffering and flush buffer
ob_end_flush();
?>


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Change Password</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-0evHe/X+R7YkIZDRvuzKMRqM+OrBnVFBL6DOitfPri4tjfHxaWutUpFmBp4vmVor" crossorigin="anonymous">
    <link rel="stylesheet" href="./css/main.css">
    <link rel="shortcut icon" href="./img/favicon-16x16.png" type="image/x-icon">
    <script defer src="./js/script.js"></script>
    <h4 class="my-4">Hello, <?= htmlspecialchars($_SESSION["username"]); ?></h4>
</head>
<body>

<h2>Change Password</h2>
<form method="post" action="<?php echo htmlspecialchars($_SERVER["PHP_SELF"]); ?>">
    <div>
        <label for="current_password">Current Password:</label>
        <input type="password" id="current_password" name="current_password" required>
    </div>
    <div>
        <label for="new_password">New Password:</label>
        <input type="password" id="new_password" name="new_password" required>
    </div>
    <div>
        <label for="confirm_password">Confirm Password:</label>
        <input type="password" id="confirm_password" name="confirm_password" required>
    </div>
    <div>
        <input type="submit" name="btnChangePassword" value="Change Password">
    </div>
</form>

<?php if (!empty($error)): ?>
    <p><?php echo $error; ?></p>
<?php endif; ?>

<?php if (isset($_SESSION['password_change_success'])) : ?>
    <p><?php echo $_SESSION['password_change_success']; ?></p>
    <?php unset($_SESSION['password_change_success']); // Clear the success message ?>
<?php endif; ?>

<!-- Add button for redirection to index.php -->
<a href="index.php"><button>Go to Index</button></a>

</body>
</html>
